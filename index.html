<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>

<script src="lib/three.js"></script>
<script src="lib/physi.js"></script>
<script src="objects/table.js"></script>
<script src="objects/ball.js"></script>
<script src="objects/cueStick.js"></script>

<script src="lib/MTLLoader.js"></script>
<script src="lib/OBJLoader.js"></script>
<script src="lib/OrbitControls.js"></script>

<script>
    Physijs.scripts.worker = 'lib/physijs_worker.js';
    Physijs.scripts.ammo = './ammo.js';
    let container, stats;
    let camera, scene, renderer;
    let mouseX = 0, mouseY = 0;
    let windowHalfX = window.innerWidth / 2;
    let windowHalfY = window.innerHeight / 2;
    let ball;
    let table = [];
    let controls;
    let cueStick;
    init();
    render();

    function doIt(mesh){
        if (! (mesh instanceof THREE.Mesh)) return;
        mesh.material.side = THREE.DoubleSide;
        let physicMesh = new Physijs.ConcaveMesh(new THREE.Geometry().fromBufferGeometry(mesh.geometry), mesh.material, 0);
        let box = new THREE.BoxHelper( physicMesh, 0xff0000 );
        scene.add(box);
        scene.add(physicMesh);
    }

    function init() {
        // scene
        scene = new Physijs.Scene();
        scene.position.set(0, 0, 0);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

        camera.lookAt(scene.position);
        controls = new THREE.OrbitControls( camera );
        camera.position.set( 0, 2, 2 );
        controls.update();

        //lights
        let spotLight = new THREE.SpotLight( 0xffffff);
        spotLight.position.set(0,50,0);
        scene.add(spotLight);

        scene.add(camera);
        let axesHelper = new THREE.AxesHelper(5);
        scene.add(axesHelper);
        // model
        let onProgress = function (xhr) {
            if (xhr.lengthComputable) {
                let percentComplete = xhr.loaded / xhr.total * 100;
                console.log(Math.round(percentComplete, 2) + '% downloaded');
            }
        };
        let onError = function (xhr) {
        };

        let mtlLoader = new THREE.MTLLoader();
        mtlLoader.setPath('objects/');
        /*mtlLoader.load('pool_table.mtl', function (materials) {
            materials.preload();
            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('objects/');
            objLoader.load('pool_table.obj', function (object) {
                if (object instanceof THREE.Object3D)
                {
                    object.traverse (function (mesh)
                    {
                        if (! (mesh instanceof THREE.Mesh)) return;
                        mesh.material.side = THREE.DoubleSide;
                    });
                }
                scene.add(object)
            }, onProgress, onError);
        });*/

        /*mtlLoader.load('cue_stick.mtl', function (materials) {
            materials.preload();
            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('objects/');
            objLoader.load('cue_stick.obj', function (object) {
                scene.add(object);
            }, onProgress, onError);
        });*/

        /*mtlLoader.load('white_ball.mtl', function (materials) {
            materials.preload();
            let objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('objects/');
            objLoader.load('white_ball.obj', function (object) {

                if (object instanceof THREE.Object3D)
                {
                    object.traverse (function (mesh)
                    {
                        if (! (mesh instanceof THREE.Mesh)) return;
                        let physicMesh = new Physijs.BoxMesh(mesh.geometry, mesh.material);
                        scene.add(physicMesh);
                    });
                }

            }, onProgress, onError);
        });*/

        createTable();
        ball = createBall();
        cueStick = createCueStick();


        renderer = new THREE.WebGLRenderer({ antialias:true });
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
    }

    function render() {
        requestAnimationFrame(render);
        cueStick.rotation.z += 0.02;
        cueStick.__dirtyRotation = true;
        controls.update();
        scene.simulate();
        renderer.render(scene, camera);

    }
</script>

</body>
</html>